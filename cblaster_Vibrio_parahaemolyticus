#!/bin/bash
###############################################################################
# cblaster local database construction and T6SS cluster searches (Vp references)
# Description:
#   1. Build local DIAMOND databases from Vibrio genomes
#   2. Search for T6SS-1 and T6SS-2 clusters using V. parahaemolyticus references
###############################################################################

# =========================
# User-defined genome list
# =========================
# Example: Vibrio_parahaemolyticus_WY3
GENOMES=(
)

# =========================
# Reference query files
# =========================
QUERY_T6SS1="t6ss1_vp.faa"
QUERY_T6SS2="t6ss2_vp.faa"

# =========================
# Step 1: Build cblaster databases
# =========================
for genome in "${GENOMES[@]}"; do
    echo "============================================================"
    echo "Building cblaster database for: ${genome}"
    echo "============================================================"

    cblaster makedb \
        -n "${genome}" \
        "${genome}.gff" \
        "${genome}.fna" \
        --cpus 4 \
        -f

    echo "Database created: ${genome}.dmnd"
    echo
done

# =========================
# Step 2: Search for T6SS-1 (Vp)
# =========================
for genome in "${GENOMES[@]}"; do
    echo "------------------------------------------------------------"
    echo "Searching for T6SS-1 (Vp reference) in: ${genome}"
    echo "------------------------------------------------------------"

    cblaster search \
        -m local \
        -db "${genome}.dmnd" \
        -qf "${QUERY_T6SS1}" \
        -s "${genome}_t6ss1_vp.json"

    echo "Results saved to ${genome}_t6ss1_vp.json"
    echo
done

# =========================
# Step 3: Search for T6SS-2 (Vp)
# =========================
for genome in "${GENOMES[@]}"; do
    echo "------------------------------------------------------------"
    echo "Searching for T6SS-2 (Vp reference) in: ${genome}"
    echo "------------------------------------------------------------"

    cblaster search \
        -m local \
        -db "${genome}.dmnd" \
        -qf "${QUERY_T6SS2}" \
        -s "${genome}_t6ss2_vp.json"

    echo "Results saved to ${genome}_t6ss2_vp.json"
    echo
done

echo "All V. parahaemolyticus T6SS cblaster analyses completed successfully."
